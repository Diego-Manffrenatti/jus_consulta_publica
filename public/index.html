<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Consulta Pública de Processos</title>
</head>
<body>
<h1>Consulta de Processos por CNPJ</h1>
<textarea id="input" rows="10" cols="50" placeholder="Cole CNPJs (um por linha)"></textarea><br/>
<button id="btnConsulta">Consultar</button>
<button id="btnDownload" disabled>Baixar Excel</button>

<script>
    const API_URL    = window.location.origin + '/api/consulta';
    const EXPORT_URL = window.location.origin + '/api/export';

    // Handler do botão "Consultar"
    document.getElementById('btnConsulta').onclick = async () => {
      const raw = document.getElementById('input').value
        .split('\n')
        .map(s => s.replace(/\D/g, ''))
        .filter(s => s.length === 14);

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cnpjs: raw })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const { processos } = await resp.json();
        window.RESULTS = processos;

        alert(`Encontrados ${processos.length} registros.`);
        document.getElementById('btnDownload').disabled = false;
      } catch (err) {
        console.error('Erro ao consultar:', err);
        alert('Erro ao consultar. Veja o console para detalhes.');
      }
    };

    // Handler do botão "Baixar Excel"
    document.getElementById('btnDownload').onclick = async () => {
      if (!window.RESULTS || !window.RESULTS.length) {
        alert('Não há processos para download.');
        return;
      }
      try {
        const resp = await fetch(EXPORT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cnpjs: window.RESULTS.map(r => r.cnpj) })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'processos.xlsx';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Erro ao baixar Excel:', err);
        alert('Falha ao baixar o Excel. Veja o console.');
      }
    };
</script>
</body>
</html>
